# 内存申请使用示例工程说明

> 本工程展示了内存申请接口使用示例:
>
> 1. 内存申请接口如何使用;
> 2. 内存泄漏如何查找;
> 3. 内存被篡改如何定位;
> 4. 内存碎片解决方法;

---

## 适用平台

> 本工程适用以下芯片类型：
> 1. AC79系列芯片：AC790N、AC791N
>
> 杰理芯片和评估板的更多信息可在以下地址获取：[链接](https://shop321455197.taobao.com/?spm=a230r.7195193.1997079397.2.2a6d391d3n5udo)

## 工程配置说明

> 在SDK选择[demo_hello](../../../../apps/demo_hello/board)主工程文件或者主工程Makefile, 然后添加本事例工程代码
>
> 如果需要测试内存泄漏, app_config.h 需要增加 #define MEM_LEAK_CHECK_ENABLE

---



### 操作说明：

> 2. 编译工程，烧录镜像，复位启动
> 3. 系统启动后，可以通过串口软件看到示例的打印信息
>
> JIELI SDK的编译、烧写等操作方式的说明可在以下文档获取：[文档](../../../../..//doc/stuff/usb%20updater.pdf)

### 代码流程

> 1. c_main()入口：
>
>    A）申请和释放内存使用
>
>    B ) 模拟内存泄漏情况
>    
>    C ) 模拟内存被篡改如何定位
---

## 常见问题

> * 如何查看内存使用情况?
>
>   答: app_config.h 增加 #define RTOS_STACK_CHECK_ENABLE 即可,打印周期默认为60秒,测试建议设置为3秒;
>
>   malloc_stats(); //打印一下当前内存使用情况,简单来看也可以发现有没有内存泄漏
>
>   DLMALLOC_STATS:
>   total: 493488   //总共内存堆可使用的大小
>   left: 435416    //当前剩余可使用的大小
>
> 
>
> * 如何启动内存泄漏侦测?
>
>   答: 有两种方法查找内存泄漏,可以同时使用;
>
>    方法1:定位一个功能模块内部有没有内存泄漏:
>
>   ​			app_config.h 需要增加 #define MEM_LEAK_CHECK_ENABLE
>
>   ​			 #include "system/mem_leak_test.h" //如果需要启动内存泄漏侦测, 必须所有需要侦测的.c和.h文件都要包含此头文件
>
>   ​			例如打印: MALLOC LEAK DBG:malloc_test_task 20 rets:0x1c10660,size:0x1000 
>
>   ​			代表发现malloc_test_task函数的第20行,rets地址为0x1c10660,申请大小为0x1000,rets可以通过工具[定位异常地址](../../../../cpu/wl80/tools/定位异常地址.bat)查看
>
> 
>
>
> ​	方法2:需要使用mem_heap库来定位不断打印定位整个SDK申请内存的情况来分析,此方法mem_heap库才有,请联系FAE替换内存申请库用于debug
>
> ​				app_config.h 需要增加 #define MEM_LEAK_CHECK_ENABLE
>
> ​				malloc_dump(); //定时打印有没有内存泄漏的情况, 
>
> 
>
> 
>
> * 内存使用导致死机的情况有哪些?
>
>   答: 用户需要排查有没有错误使用内存申请的情况,例如:
>
>   1.读写操作的地址范围超出内存申请指针包含的范围
>
>   2.内存指针释放了还继续使用
>
>   3.多次释放同一个内存申请的指针
>
> 
>
> * 感觉到内存被篡改但是没有马上造成异常的情况应该如何定位?
>
>   答: 需要使用mem_heap库来定位, 需要在流程上存在篡改可能性的地方加入mem_heap_check函数来分析,此方法mem_heap库才有,请联系FAE替换内存申请库用于debug
>   
>   
>   
> * 有时候发现内存堆空间足够,但是内存申请失败的原因是什么?
>
>   答: 由于内存碎片导致没有一块连续的并且足够大内存可以申请导致的, 用户使用内存申请注意不要申请过于小size的内存,另外常驻内存不要使用malloc,直接使用静态变量,malloc多个变量的情况考虑优化成一次性malloc一个结构体使用

## 参考文档

> * [LWIP MEM_HEAP原理分析](https://blog.csdn.net/u014170207/article/details/89260169)